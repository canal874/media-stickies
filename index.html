<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<link href="https://use.fontawesome.com/releases/v5.0.6/css/all.css" rel="stylesheet">
<style>

.cke_combo__fontsize a.cke_combo_button .cke_combo_text{
  width:28px;
  padding-left: 0px;
}
.cke_combo__fontsize a.cke_combo_button .cke_combo_open{
  margin-left:0px;
  margin-right:0px;
}

#cke_editor .cke_combo::after,
#cke_editor .cke_toolgroup a.cke_button:last-child:after,
#cke_editor .cke_toolgroup a.cke_button.cke_button_disabled:last-child:after
{
  border: none;
}

#cke_editor{
  margin-top: 18px;
  border: 0px;
  display: none;    
}
/*
#cke_1_bottom{
  display:none;
}*/

body{
  margin: 0px;
  padding: 0px;
  overflow-x: hidden;
  overflow-y: hidden;
}

body .cke_screen_reader_only{
  display:none;
}

#card{
  position: absolute;
  top: 0px;
  left: 0px;
  width: 100%;
  height: 100%;
  padding: 0px;
  margin: 0px;
  border: 3px solid transparent;
  box-sizing: border-box;
  visibility: hidden;
}

#card #titlearea{
  position: absolute;
  top: 0px;
  left: 0px;
  padding: 0px;
  margin: 0px;
}

#card .title-bar{
  position: absolute;
  top: 0px;
  height: 18px;
  -webkit-app-region: drag;
  padding: 0px;
  margin: 0px;
}

#card .title-btn{
  position: absolute;
  top: 0px;
  width: 14px;
  height: 16px; 
  text-align: center; 
  font-size: 14px;
  padding: 1px; 
  cursor: pointer;
}

#card #titlebar{
  left: 39px;
   width:207px;
}

#card #newBtn{
  left:0px;
} 

#card #separator01{
  left: 16px;
  width: 7px;
}

#card #codeBtn{
  left: 23px;
}
    
#card #closeBtn{
  left: 246px;
}
  
#card #contents{
  padding: 2px;
  font-size: 16px;
  font-family: sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
  top: 18px;
  left: 0px;
  width: 10px;
  height: 10px;
  position: absolute;
  margin: 0px;
  border: 0px;
  z-index: 10;
}



</style>
<script type="text/javascript" src="ckeditor/ckeditor.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script>
// See https://github.com/electron/electron/issues/254
if (typeof module === "object" && module.exports) {
  window.$ = window.jQuery = module.exports;
  module.exports = {};
}

const card = { id: "" };

$(() => {
  let main = require("electron").remote.require("./main");
  const ipcRenderer = require( "electron" ).ipcRenderer;
  
  const {remote} = require('electron');
  const {Menu, MenuItem} = remote;

  //-----------------------------------
  // ContextMenu
  //-----------------------------------
  var menu = new Menu();
  menu.append(new MenuItem({ label: main.i18n("yellow"), click: () => { setCardColor("#ffffa0"); }}));
  menu.append(new MenuItem({ label: main.i18n("red"), click: () => { setCardColor("#ffd0d0"); }}));
  menu.append(new MenuItem({ label: main.i18n("green"), click: () => { setCardColor("#d0ffd0"); }}));
  menu.append(new MenuItem({ label: main.i18n("blue"), click: () => { setCardColor("#d0d0ff"); }}));
  menu.append(new MenuItem({ label: main.i18n("purple"), click: () => { setCardColor("#ffd0ff"); }}));
  menu.append(new MenuItem({ label: main.i18n("gray"), click: () => { setCardColor("#d0d0d0"); }}));
  menu.append(new MenuItem({ label: main.i18n("transparent"), click: () => { setCardColor("#f0f0f0", 0.0); }}));
  
  document.ondragover = (e) => {
    e.preventDefault();
    return false;
  };

  document.ondrop = (e) => {
    e.preventDefault();

    var file = e.dataTransfer.files[0];

    var dropImg = new Image();
    dropImg.onload = () => {
      var width = dropImg.naturalWidth;
      var height = dropImg.naturalHeight;

      // Adjust img to card size
      // ...
      // ...

      var data = "<img src='" + file.path + "' width='" + width + "' height='" + height + "'>";
      CKEDITOR.instances["editor"].setData(data);
      $("#contents").html(data);
    };
    dropImg.src = file.path;

    return false;
  };


  window.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    menu.popup(remote.getCurrentWindow());
  }, false);

  
  //-----------------------------------
  // Global
  //-----------------------------------
  let codeMode = false;

  let toolbarHeight = 64;

  let currentCardColor = "#f0f0a0";
  let currentTitleColor = "#d0d090";
  let currentBgOpacity = 1.0;
  
  let isEditorReady = false;
  
  //----------------------
  // ipc (inter-process communication)
  //----------------------

  // Initialize card
  ipcRenderer.on("card-loaded", (event, id, data, x, y,  width, height, color, bgOpacity) => {
    card.id = id;
    Object.freeze(card);
    
    $("#editor").val(data);
    $("#contents").html(data);

    setCardColor(color, bgOpacity);

    var sprBorder = parseInt($("#card").css("border-left"));
    var sprWidth = width - sprBorder*2;
    var sprHeight = height - sprBorder*2;
    CKEDITOR.config.width =  sprWidth;
    CKEDITOR.config.height =  sprHeight - $("#titlebar").outerHeight() - toolbarHeight; 
    resizeWindow();

//    CKEDITOR.config.uiColor = currentTitleColor;
    CKEDITOR.replace("editor"); 
    CKEDITOR.on("instanceReady", () => {
      isEditorReady = true;
      $("#cke_editor").css('border-top-color', currentTitleColor);      
      $("#cke_1_top").css('background-color', currentTitleColor);
      $("#cke_1_top").css('border-bottom-color', currentTitleColor);
      $("#cke_1_top").css('border-top-color', currentTitleColor);
      $("#cke_1_contents .cke_wysiwyg_frame").css('background-color', currentCardColor);
    });

    setTimeout(()=>{
      $("#card").css("visibility", "visible");
    },300);
  });

  ipcRenderer.on("card-close", (event) => {
    close();
  });

  ipcRenderer.on("card-focused", (event) => {
    $("#card").css({ border: "3px solid red" });
    $("#titlearea").show();
  });
  
  ipcRenderer.on("card-blured", (event) => {
    if($("#contents").css("display") == "none"){
      endEditMode();
    }
    $("#card").css({ border: "3px solid transparent" });
    if(currentBgOpacity == 0){
      $("#titlearea").hide();
    }
  });

  //--------------------------
  // Set card properties
  //--------------------------  
  // cardColor : #HEX (e.g. #ff00ff)
  // cardColor : 0.0-1.0
  let setCardColor = (cardColor, bgOpacity) => {
    currentCardColor = cardColor;
    currentBgOpacity = bgOpacity === undefined ? 1.0 : bgOpacity;
    let scale = 0.8;
    cardColor.match(/#(\w\w)(\w\w)(\w\w)/)
    let red = parseInt(RegExp.$1, 16);
    let green = parseInt(RegExp.$2, 16);
    let blue = parseInt(RegExp.$3, 16);
    $(".card-color").css("background-color", "rgba("+ red + "," + green + "," + blue + "," + currentBgOpacity + ")");

    let r = Math.floor(red * scale).toString(16);
    if (r.length == 1){r= "0" + r;}
    let g = Math.floor(green * scale).toString(16);
    if (g.length == 1){g= "0" + g;}
    let b = Math.floor(blue * scale).toString(16);
    if (b.length == 1){b= "0" + b;}
    currentTitleColor = "#" + r + g + b;

    $(".title-color").css("background-color", currentTitleColor);

　　if(isEditorReady){
      $("#cke_editor").css('border-top-color', currentTitleColor);      
      $("#cke_1_top").css('background-color', currentTitleColor);
      $("#cke_1_top").css('border-bottom-color', currentTitleColor);
      $("#cke_1_top").css('border-top-color', currentTitleColor);
      $("#cke_1_contents .cke_wysiwyg_frame").css('background-color', currentcardColor);
    }
  };

  //--------------------------
  // Save and close card
  //--------------------------  
  let close = () => {
    window.close();
  };


  //--------------------------
  // Edit
  //--------------------------  
  let moveCursorToBottom = () => {
    let editor = CKEDITOR.instances["editor"];
    let s = editor.getSelection(); // getting selection
    let selected_ranges = s.getRanges(); // getting ranges
    let node = selected_ranges[0].startContainer; // selecting the starting node
    let parents = node.getParents(true);
    node = parents[parents.length - 2].getFirst();
    while (true) {
      let x = node.getNext();
      if (x == null) {
        break;
      }
      node = x;
    }

    s.selectElement(node);
    selected_ranges = s.getRanges();
    selected_ranges[0].collapse(false);  //  false collapses the range to the end of the selected node, true before the node.
    s.selectRanges(selected_ranges);  // putting the current selection there

  };

  let startEditMode = () => {
    $("#contents").hide();
    $("#cke_editor").show();

    execAfterWysiwygChanged(
      function(){
        resizeWindow();
        CKEDITOR.instances["editor"].focus();
        moveCursorToBottom();
      }
    );
  };

  let endEditMode = () => {
    let data = CKEDITOR.instances["editor"].getData();
    $("#contents").html(data);
    $("#contents").show();
    setTimeout(() => {
      main.saveCard(card.id, data, currentCardColor, currentBgOpacity);
    },1);
    $("#cke_editor").hide();

    codeMode = false;
    $("#codeBtn").css({ "color":"#000000" });
    CKEDITOR.instances["editor"].setMode("wysiwyg");
  };

  let startCodeMode = () => {
    codeMode = true;
    startEditMode();
    $("#codeBtn").css({ "color":"#a0a0a0" });
    CKEDITOR.instances["editor"].setMode("source");
    CKEDITOR.instances["editor"].focus();
  };

  let execAfterWysiwygChanged = (func) => {
    let editor = CKEDITOR.instances["editor"];
    let s = editor.getSelection(); // getting selection
    if(s){
      func();
    }
    else{
      setTimeout(() => {execAfterWysiwygChanged(func)}, 100);
    }
  };
  
  let endCodeMode = () => {
    codeMode = false;
    $("#codeBtn").css({ "color":"#000000" });
    CKEDITOR.instances["editor"].setMode("wysiwyg");
    execAfterWysiwygChanged(
      function(){
        CKEDITOR.instances["editor"].focus();
        moveCursorToBottom();
      }
    );
  };

  //--------------------------
  // UI
  //--------------------------
  let resizeWindow = () => {
//    console.log("card resize: " + $(window).width() + "," + $(window).height());
    var sprBorder = parseInt($("#card").css("border-left"));
    var sprWidth = $(window).width() - sprBorder*2;
    var sprHeight = $(window).height() - sprBorder*2;

    var contPadding = parseInt($("#contents").css("padding-left"))
    $("#contents").width(sprWidth - contPadding*2);
    $("#contents").height(sprHeight - $("#titlebar").outerHeight() - contPadding*2);

    if(isEditorReady){
//      CKEDITOR.instances["editor"].resize(sprWidth, sprHeight - $("#titlebar").outerHeight());
      CKEDITOR.instances["editor"].resize(sprWidth, sprHeight - $("#titlebar").outerHeight());
    }

    let closeBtnLeft = sprBorder + sprWidth - $("#closeBtn").outerWidth();
    $("#closeBtn").offset({ left: closeBtnLeft });
    let titleBarLeft = $("#codeBtn").position().left + $("#codeBtn").outerWidth();
    let barwidth = closeBtnLeft - titleBarLeft;
    $("#titlebar").offset({ left: titleBarLeft });
    $("#titlebar").width(barwidth);
  };

  $(window).resize(() => {
    resizeWindow();
  });

  $("#newBtn").click(() => {
    main.createCard();
  });

  $("#contents").click(() => {
    startEditMode();
  });

  $("#codeBtn").click(() => {
    if(!codeMode){
      startCodeMode();
    }
    else{
      endCodeMode();
    }
  });

  $("#closeBtn").click(() => {
    let data = CKEDITOR.instances["editor"].getData();
    if(data == ""){
      main.saveToCloseCard(card.id, data, currentCardColor, currentBgOpacity);
    }
    else if(window.confirm(main.i18n("confirm-closing"))){
      main.saveToCloseCard(card.id, data, currentCardColor, currentBgOpacity);
    }
  });

});

</script>
</head>
<body>
<!-- 
-webkig-app-region:drag を設定した子要素は、マウスイベントを取得できないので注意 
-->
<div id="card">
  <div id="titlearea">
    <div id="titlebar" class="title-color title-bar"></div>
    <div id="newBtn" class="title-color title-btn"><i class="fas fa-plus"></i></div>
    <!-- ボタンの間を埋める -->
    <div id="separator01" class="title-color title-bar" style="left: width"></div>
    <div id="codeBtn" class="title-color title-btn"><i class="fas fa-code"></i></div>
    <div id="closeBtn" class="title-color title-btn"><i class="fas fa-minus-circle"></i></div>
  </div>
  <div id="contents" class="card-color"></div>

  <textarea id="editor"></textarea>
</div>

</body>
</html>