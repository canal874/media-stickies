<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<link href="https://use.fontawesome.com/releases/v5.0.6/css/all.css" rel="stylesheet">
<style>
.title-color{
  background-color:#d0d090;
}
.default-color{
  background-color:#f0f0a0;
}
.cke_combo__fontsize a.cke_combo_button .cke_combo_text{

  width:28px;
  padding-left: 0px;
}
.cke_combo__fontsize a.cke_combo_button .cke_combo_open{
  margin-left:0px;
  margin-right:0px;
}
</style>
<script type="text/javascript" src="ckeditor/ckeditor.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script>
// See https://github.com/electron/electron/issues/254
if (typeof module === "object" && module.exports) {
  window.$ = window.jQuery = module.exports;
  module.exports = {};
}

const sprite = { id: "" };

$(() => {
  let main = require("electron").remote.require("./main");
  const ipcRenderer = require( 'electron' ).ipcRenderer;
  
  let codeMode = false;

  let prevData = "";

  //----------------------
  // Initialize sprite
  //----------------------
  ipcRenderer.on('sprite-loaded', (event, id, data) => {
    sprite.id = id;
    Object.freeze(sprite);
    prevData = data;
    $('#editor').val(data);
    $('#contents').html(data);

    CKEDITOR.replace("editor");
  });

  //--------------------------
  // Save and close sprite
  //--------------------------  
  let close = () => {
    window.close();
  };

  ipcRenderer.on('sprite-saved-to-close', (event) => {
    close();
  });

  //--------------------------
  // Edit
  //--------------------------  
  let startCodeMode = () => {
    codeMode = true;
    $('#codeBtn').css({ 'color':'#000000' });
//    $('#editor').html($('#contents').html());
    $('#contents').hide();
    $('#editor').show();
  };

  let endCodeMode = () => {
    codeMode = false;
    $('#codeBtn').css({ 'color':'#a0a0a0' });
    let data = CKEDITOR.instances["editor"].getData();
    $('#contents').html(data);
    $('#contents').show();
    $('#editor').hide();
  };

  //--------------------------
  // UI
  //--------------------------  

  $(window).resize(() => {
    let barwidth = $(window).width() -48;
    $('#titlebar').width(barwidth);

    let padding = 2;
    $('#contents').width($(window).width() - padding*2);
    $('#contents').height($(window).height() - padding*2);

    $('#editor').width($(window).width() - padding*2);
    $('#editor').height($(window).height() - padding*2);
  });

  $('#contents').click(() => {
      startCodeMode();
  });

  $('#codeBtn').click(() => {
      if(!codeMode){
        startCodeMode();
      }
      else{
        endCodeMode();
      }
  });

  $('#closeBtn').click(() => {
//    let data = $('#editor').val();
    let data = CKEDITOR.instances["editor"].getData();
    if(prevData == data){
      close();
    }
    else{
      main.saveToCloseSprite(sprite.id, data);
    }
  });
});

</script>
</head>
<body style="margin:0px; padding:0px;">
<!-- 
-webkig-app-region:drag を設定した子要素は、マウスイベントを取得できないので注意 
-->
<div id="titlebar" class="title-color" style="top:0px; left:34px; width:212px; height:16px; position:absolute; -webkit-app-region:drag; padding:0px; margin:0px;"></div>

<div id="newBtn" class="title-color" style="position:absolute; top:0px; left:0px; width:14px; height:14px; text-align:center; font-size:14px; padding:1px; cursor:pointer"><i class="fas fa-plus"></i></div>

<!-- ボタンの間を埋める -->
<div class="title-color" style="top:0px; left:16px; width:2px; height:16px; position:absolute; -webkit-app-region:drag; padding:0px; margin:0px;"></div>

<div id="codeBtn" class="title-color" style="position:absolute; top:0px; left:18px; width:14px; height:14px; text-align:center; font-size:14px; padding:1px; cursor:pointer;"><i class="fas fa-code"></i></div>

<div id="closeBtn" class="title-color" style="position:absolute; top:0px; right:0px; width:14px; height:14px; text-align:center; font-size:14px; padding:1px; cursor:pointer;"><i class="fas fa-minus-circle"></i></div>

<div id="contents" class="default-color" style="padding: 2px; font-size: 16px; font-family:sans-serif; top:16px; left:0px; width:256px; height:154px; position:absolute; margin:0px;border:0px; z-index:10">
</div>

<textarea id="editor" style="padding: 0px; font-size: 16px; font-family:sans-serif; top:16px; left:0px; width:256px; height:154px; position:absolute; margin:0px;border:0px; visibility:hidden;">
</textarea>

</body>
</html>